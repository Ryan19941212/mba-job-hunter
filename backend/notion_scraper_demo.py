#!/usr/bin/env python3
"""
Complete Notion + Scraper Integration Demo

Demonstrates the full workflow from job scraping to Notion database creation
and data synchronization for the MBA Job Hunter application.
"""

import asyncio
import sys
import os
from datetime import datetime, timezone
from typing import List, Dict
import random

# Add the app directory to Python path  
sys.path.insert(0, os.path.join(os.path.dirname(__file__), 'app'))

from services.notion_writer import NotionWriter
from scrapers.indeed import IndeedScraper
from scrapers.base import JobData, ScrapingConfig
from scrapers.utils import calculate_job_relevance_score

def print_banner():
    """Print demo banner."""
    print("üéØ" + "=" * 58 + "üéØ")
    print("üöÄ MBA Job Hunter: Notion + Scraper Integration Demo")
    print("üéØ" + "=" * 58 + "üéØ")
    print()

async def demo_notion_database_setup():
    """Demo Notion database setup and schema."""
    print("üìã 1. Notion Database Setup")
    print("-" * 40)
    
    # Check for API key
    api_key = os.getenv("NOTION_API_KEY")
    if not api_key:
        print("‚ö†Ô∏è  NOTION_API_KEY not set - using demo mode")
        api_key = "dummy_key_for_demo"
    
    try:
        async with NotionWriter(api_key=api_key) as writer:
            # Test database schema
            schema = writer._get_database_properties_schema()
            
            print(f"‚úÖ Generated database schema with {len(schema)} properties")
            
            # Show key properties
            key_props = [
                "Job Title", "Company", "Location", "Salary Min", "Salary Max",
                "Application Status", "MBA Relevance", "AI Fit Score"
            ]
            
            print("üèóÔ∏è Key database properties:")
            for prop in key_props:
                if prop in schema:
                    prop_type = list(schema[prop].keys())[0]
                    print(f"   ‚Ä¢ {prop}: {prop_type}")
            
            # Test connection if real API key
            if api_key != "dummy_key_for_demo":
                connection_ok = await writer.test_connection()
                if connection_ok:
                    print("‚úÖ Notion API connection successful!")
                    
                    # Try to get or create database
                    try:
                        database_id = await writer.get_or_create_database("MBA Job Hunter Demo")
                        print(f"‚úÖ Database ready: {database_id}")
                        return database_id
                    except Exception as e:
                        print(f"‚ö†Ô∏è  Database setup failed: {e}")
                else:
                    print("‚ùå Notion API connection failed")
            else:
                print("üìù Demo mode - no real API calls made")
            
    except Exception as e:
        print(f"‚ùå Setup failed: {e}")
    
    print()
    return None

async def demo_job_scraping_simulation():
    """Demo job scraping (simulated data)."""
    print("üìã 2. Job Scraping Simulation")
    print("-" * 40)
    
    try:
        # Create scraper configuration
        config = ScrapingConfig(
            max_pages=2,
            delay_between_requests=1.0,
            rate_limit_per_minute=20
        )
        
        scraper = IndeedScraper(config)
        
        print(f"‚úÖ Created Indeed scraper:")
        print(f"   ‚Ä¢ Name: {scraper.name}")
        print(f"   ‚Ä¢ Base URL: {scraper.base_url}")
        print(f"   ‚Ä¢ Type: {scraper.scraper_type}")
        
        # Generate sample job data (simulating scraped jobs)
        sample_jobs = []
        
        job_templates = [
            {
                "title": "Senior Product Manager - MBA Required",
                "company_name": "Google",
                "location": "Mountain View, CA",
                "description": "Lead product strategy for our AI platform. Work with cross-functional teams to define product roadmap and drive growth initiatives. MBA from top-tier school required.",
                "requirements": "‚Ä¢ MBA from top business school\n‚Ä¢ 5+ years product management experience\n‚Ä¢ Strong analytical and strategic thinking skills\n‚Ä¢ Experience with data-driven decision making",
                "salary_min": 150000,
                "salary_max": 220000,
                "job_type": "Full-time",
                "experience_level": "Senior Level",
                "skills_required": ["MBA", "Product Management", "Strategy", "Analytics", "Leadership"]
            },
            {
                "title": "Management Consultant",
                "company_name": "McKinsey & Company",
                "location": "New York, NY", 
                "description": "Work with Fortune 500 clients on strategic initiatives. Conduct market analysis, develop business cases, and present recommendations to C-level executives.",
                "requirements": "‚Ä¢ MBA from top-tier program\n‚Ä¢ 2+ years consulting experience\n‚Ä¢ Strong problem-solving skills\n‚Ä¢ Excellent communication abilities",
                "salary_min": 165000,
                "salary_max": 200000,
                "job_type": "Full-time",
                "experience_level": "Mid Level",
                "skills_required": ["MBA", "Consulting", "Strategy", "Financial Modeling", "Presentation"]
            },
            {
                "title": "Business Development Manager",
                "company_name": "Salesforce",
                "location": "San Francisco, CA",
                "description": "Drive business growth through strategic partnerships and client relationships. Identify new market opportunities and develop go-to-market strategies.",
                "requirements": "‚Ä¢ MBA preferred\n‚Ä¢ 3+ years business development experience\n‚Ä¢ Strong relationship building skills\n‚Ä¢ Experience in SaaS industry",
                "salary_min": 120000,
                "salary_max": 160000,
                "job_type": "Full-time", 
                "experience_level": "Mid Level",
                "skills_required": ["MBA", "Business Development", "Sales", "Strategy", "Communication"]
            },
            {
                "title": "Strategy Analyst",
                "company_name": "Amazon",
                "location": "Seattle, WA",
                "description": "Support strategic planning initiatives across business units. Conduct competitive analysis, financial modeling, and market research to inform key business decisions.",
                "requirements": "‚Ä¢ MBA or advanced degree\n‚Ä¢ Strong analytical skills\n‚Ä¢ Proficiency in Excel and SQL\n‚Ä¢ Experience with data visualization tools",
                "salary_min": 110000,
                "salary_max": 140000,
                "job_type": "Full-time",
                "experience_level": "Entry Level",
                "skills_required": ["MBA", "Strategy", "Analytics", "SQL", "Financial Modeling"]
            },
            {
                "title": "Operations Manager",
                "company_name": "Apple",
                "location": "Cupertino, CA",
                "description": "Lead operational excellence initiatives and process improvements. Manage cross-functional projects to optimize supply chain and manufacturing operations.",
                "requirements": "‚Ä¢ MBA in Operations or related field\n‚Ä¢ 4+ years operations experience\n‚Ä¢ Lean/Six Sigma certification preferred\n‚Ä¢ Strong project management skills",
                "salary_min": 130000,
                "salary_max": 170000,
                "job_type": "Full-time",
                "experience_level": "Senior Level", 
                "skills_required": ["MBA", "Operations Management", "Process Improvement", "Project Management", "Lean"]
            }
        ]
        
        # Create JobData objects
        for i, template in enumerate(job_templates):
            job_data = JobData(
                title=template["title"],
                company_name=template["company_name"],
                location=template["location"],
                description=template["description"],
                requirements=template["requirements"],
                salary_min=template["salary_min"],
                salary_max=template["salary_max"],
                salary_currency="USD",
                salary_period="annual",
                job_type=template["job_type"],
                experience_level=template["experience_level"],
                source="indeed",
                source_job_id=f"job_{i+1}",
                source_url=f"https://indeed.com/viewjob?jk=sample_{i+1}",
                skills_required=template["skills_required"],
                is_remote=random.choice([True, False]),
                posted_date=datetime.now(timezone.utc)
            )
            
            # Convert to dict for processing
            job_dict = {
                "title": job_data.title,
                "company_name": job_data.company_name,
                "location": job_data.location,
                "description": job_data.description,
                "requirements": job_data.requirements,
                "salary_min": job_data.salary_min,
                "salary_max": job_data.salary_max,
                "salary_currency": job_data.salary_currency,
                "job_type": job_data.job_type,
                "experience_level": job_data.experience_level,
                "source": job_data.source,
                "source_url": job_data.source_url,
                "skills_required": job_data.skills_required,
                "is_remote": job_data.is_remote,
                "posted_date": job_data.posted_date
            }
            
            # Calculate relevance score
            job_dict["relevance_score"] = calculate_job_relevance_score(job_dict)
            
            sample_jobs.append(job_dict)
        
        print(f"‚úÖ Generated {len(sample_jobs)} sample jobs")
        
        # Show job summary
        for i, job in enumerate(sample_jobs, 1):
            relevance = job["relevance_score"]
            relevance_label = "High" if relevance >= 0.7 else "Medium" if relevance >= 0.4 else "Low"
            
            print(f"   {i}. {job['title']} at {job['company_name']}")
            print(f"      üí∞ ${job['salary_min']:,} - ${job['salary_max']:,}")
            print(f"      üéØ MBA Relevance: {relevance:.2f} ({relevance_label})")
        
        print()
        return sample_jobs
        
    except Exception as e:
        print(f"‚ùå Scraping simulation failed: {e}")
        print()
        return []

async def demo_notion_integration(jobs_data: List[Dict], database_id: str = None):
    """Demo Notion integration with scraped jobs."""
    print("üìã 3. Notion Integration Demo")
    print("-" * 40)
    
    if not jobs_data:
        print("‚ö†Ô∏è  No job data available for Notion integration")
        print()
        return
    
    api_key = os.getenv("NOTION_API_KEY", "dummy_key_for_demo")
    
    try:
        async with NotionWriter(api_key=api_key, database_id=database_id) as writer:
            print(f"‚úÖ Notion writer initialized")
            
            # Format jobs for Notion
            formatted_jobs = []
            
            print("üîÑ Formatting jobs for Notion...")
            for i, job in enumerate(jobs_data, 1):
                try:
                    formatted = await writer.format_job_for_notion(job)
                    formatted_jobs.append(formatted)
                    
                    # Show formatting details
                    properties = formatted.get("properties", {})
                    children = formatted.get("children", [])
                    
                    print(f"   {i}. {job['title']}")
                    print(f"      üìä Properties: {len(properties)}")
                    print(f"      üìÑ Content blocks: {len(children)}")
                    
                except Exception as e:
                    print(f"   ‚ùå Failed to format job {i}: {e}")
            
            print(f"‚úÖ Successfully formatted {len(formatted_jobs)} jobs")
            
            # Demo batch processing
            if api_key != "dummy_key_for_demo":
                print("\nüöÄ Starting batch write to Notion...")
                try:
                    page_ids = await writer.batch_write_jobs(jobs_data)
                    print(f"‚úÖ Successfully created {len(page_ids)} job pages")
                    
                    # Show statistics
                    stats = writer.get_stats()
                    print(f"\nüìä Notion Writer Statistics:")
                    print(f"   ‚Ä¢ Jobs written: {stats['jobs_written']}")
                    print(f"   ‚Ä¢ Jobs updated: {stats['jobs_updated']}")
                    print(f"   ‚Ä¢ Errors: {stats['errors']}")
                    print(f"   ‚Ä¢ Last sync: {stats['last_sync']}")
                    
                except Exception as e:
                    print(f"‚ùå Batch write failed: {e}")
            else:
                print("üìù Demo mode - jobs formatted but not written to Notion")
                print("   Set NOTION_API_KEY environment variable for real integration")
    
    except Exception as e:
        print(f"‚ùå Notion integration failed: {e}")
    
    print()

async def demo_end_to_end_workflow():
    """Demo complete end-to-end workflow."""
    print("üìã 4. End-to-End Workflow Demo")
    print("-" * 40)
    
    print("üîÑ Simulating complete MBA job hunting workflow:")
    print()
    
    # Step 1: Initialize services
    print("1Ô∏è‚É£ Initializing services...")
    api_key = os.getenv("NOTION_API_KEY", "dummy_key_for_demo")
    
    config = ScrapingConfig(
        max_pages=3,
        delay_between_requests=1.0,
        rate_limit_per_minute=30
    )
    
    scraper = IndeedScraper(config)
    
    print("   ‚úÖ Scraper configured")
    print("   ‚úÖ Notion writer ready")
    
    # Step 2: Search parameters
    print("\n2Ô∏è‚É£ Setting up job search parameters...")
    search_queries = ["Product Manager", "Business Analyst", "Strategy Consultant"]
    locations = ["San Francisco", "New York", "Remote"]
    
    for query in search_queries:
        for location in locations:
            params = scraper._build_search_params(query, location, salary_min=100000)
            from urllib.parse import urlencode
            url = f"{scraper.base_url}/jobs?{urlencode(params)}"
            print(f"   üìã {query} in {location}")
    
    print("   ‚úÖ Search parameters configured")
    
    # Step 3: Simulate data processing pipeline
    print("\n3Ô∏è‚É£ Processing job data pipeline...")
    
    # Sample job for pipeline demo
    sample_job = {
        "title": "Senior Product Manager - MBA Program",
        "company_name": "Tech Innovators Inc",
        "location": "San Francisco, CA",
        "description": "Lead product strategy for our fintech platform. MBA from top program required.",
        "salary_min": 140000,
        "salary_max": 180000,
        "source": "indeed",
        "source_url": "https://indeed.com/viewjob?jk=pipeline_demo",
        "skills_required": ["MBA", "Product Management", "Strategy", "Fintech", "Leadership"]
    }
    
    # Step 3a: Calculate relevance
    relevance = calculate_job_relevance_score(sample_job)
    sample_job["relevance_score"] = relevance
    print(f"   üìä MBA relevance calculated: {relevance:.2f}")
    
    # Step 3b: Format for Notion
    async with NotionWriter(api_key=api_key) as writer:
        formatted = await writer.format_job_for_notion(sample_job)
        properties_count = len(formatted.get("properties", {}))
        blocks_count = len(formatted.get("children", []))
        
        print(f"   üîÑ Formatted for Notion: {properties_count} properties, {blocks_count} blocks")
        
        # Step 3c: Simulate duplicate check
        existing_page = await writer.find_existing_job(sample_job["source_url"])
        if existing_page:
            print(f"   üîç Found existing job: {existing_page}")
        else:
            print("   üÜï New job detected")
        
        print("   ‚úÖ Pipeline processing complete")
    
    # Step 4: Show integration benefits
    print("\n4Ô∏è‚É£ Integration benefits:")
    print("   üéØ Automated MBA relevance scoring")
    print("   üìä Rich Notion database with structured data")
    print("   üîÑ Duplicate detection and updates")
    print("   üìà Application tracking and status management")
    print("   üé® Beautiful job descriptions with formatting")
    print("   üè∑Ô∏è Skill tagging and categorization")
    
    print("\n‚úÖ End-to-end workflow demonstration complete!")
    print()

def show_setup_instructions():
    """Show setup instructions for users."""
    print("üìã 5. Setup Instructions")
    print("-" * 40)
    
    print("üöÄ To use the complete MBA Job Hunter system:")
    print()
    
    print("1Ô∏è‚É£ Notion Setup:")
    print("   ‚Ä¢ Go to https://www.notion.so/my-integrations")
    print("   ‚Ä¢ Create a new integration")
    print("   ‚Ä¢ Copy the API key")
    print("   ‚Ä¢ Set NOTION_API_KEY environment variable")
    print()
    
    print("2Ô∏è‚É£ Environment Configuration:")
    print("   ‚Ä¢ Create .env file in backend directory")
    print("   ‚Ä¢ Add: NOTION_API_KEY=your_api_key_here")
    print("   ‚Ä¢ Optionally add: NOTION_DATABASE_ID=existing_database_id")
    print()
    
    print("3Ô∏è‚É£ Run the System:")
    print("   ‚Ä¢ python3 notion_scraper_demo.py")
    print("   ‚Ä¢ The system will create a database if none exists")
    print("   ‚Ä¢ Jobs will be automatically scraped and added to Notion")
    print()
    
    print("4Ô∏è‚É£ Notion Database Features:")
    print("   ‚Ä¢ üìù Job title, company, location, description")
    print("   ‚Ä¢ üí∞ Salary range with currency support")  
    print("   ‚Ä¢ üéØ MBA relevance scoring (High/Medium/Low)")
    print("   ‚Ä¢ üìä AI fit score and analysis")
    print("   ‚Ä¢ üè∑Ô∏è Skills tagging and requirements")
    print("   ‚Ä¢ üìã Application status tracking")
    print("   ‚Ä¢ üìÖ Posted dates and deadlines")
    print("   ‚Ä¢ üè¢ Company information and logos")
    print()
    
    print("5Ô∏è‚É£ Workflow Integration:")
    print("   ‚Ä¢ üîç Scrape jobs from Indeed (and other boards)")
    print("   ‚Ä¢ üéØ Automatically score MBA relevance")
    print("   ‚Ä¢ üìä Create rich Notion pages with formatted content")
    print("   ‚Ä¢ üîÑ Handle duplicates and updates intelligently")
    print("   ‚Ä¢ üìà Track application progress")
    print("   ‚Ä¢ üé® Beautiful, organized job database")
    print()

async def main():
    """Run the complete Notion + Scraper integration demo."""
    print_banner()
    
    try:
        # Demo components
        database_id = await demo_notion_database_setup()
        jobs_data = await demo_job_scraping_simulation()
        await demo_notion_integration(jobs_data, database_id)
        await demo_end_to_end_workflow()
        show_setup_instructions()
        
        print("üéâ Notion + Scraper Integration Demo Complete!")
        print("üöÄ Your MBA Job Hunter system is ready to use!")
        
    except Exception as e:
        print(f"‚ùå Demo failed: {e}")
        return False
    
    return True

if __name__ == "__main__":
    asyncio.run(main())